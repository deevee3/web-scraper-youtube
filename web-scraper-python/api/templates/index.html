<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cafe24 Scraper UI</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.10/css/pico.min.css"
    />
    <style>
      body {
        padding: 2rem 0;
      }
      header,
      main {
        max-width: 960px;
        margin: 0 auto;
      }
      .runs-table {
        width: 100%;
      }
      .runs-table td,
      .runs-table th {
        font-size: 0.95rem;
        vertical-align: top;
      }
      .status-pill {
        display: inline-block;
        padding: 0.2rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .status-queued {
        background: #f2f4f8;
        color: #39424e;
      }
      .status-running {
        background: #fef3c7;
        color: #92400e;
      }
      .status-succeeded {
        background: #d1fae5;
        color: #065f46;
      }
      .status-failed {
        background: #fee2e2;
        color: #991b1b;
      }
      .download-links {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .preview {
        margin-top: 1rem;
      }
      .preview-card {
        border: 1px solid #dcdfe3;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fff;
      }
      .preview-card h4 {
        margin: 0 0 0.5rem 0;
      }
      .preview-card details {
        margin-top: 0.5rem;
      }
      .status-pulse {
        animation: pulse 1.2s ease-in-out infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.45;
        }
        100% {
          opacity: 1;
        }
      }
      tr.flash {
        animation: flashRow 1.5s ease-in-out 2;
      }
      @keyframes flashRow {
        0% {
          background-color: rgba(34, 197, 94, 0.18);
        }
        100% {
          background-color: transparent;
        }
      }
      .log-link {
        font-size: 0.85rem;
      }
      .timestamp {
        font-size: 0.9rem;
        color: #5b6270;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Cafe24 Scraper Control Panel</h1>
      <p>Launch a scrape using the latest Cafe24 product list and download the Shopify-ready deliverables.</p>
    </header>

    <main>
      <section>
        <h2>Start a Run</h2>
        <form action="/runs" method="post" enctype="multipart/form-data">
          <fieldset>
            <legend>Choose input source</legend>
            <label>
              <input type="radio" name="use_default" value="default" checked />
              Use server CSV ({{ default_input }})
            </label>
            <label>
              <input type="radio" name="use_default" value="upload" />
              Upload CSV
            </label>
            <input type="file" name="upload" accept=".csv" />
          </fieldset>
          <button type="submit">Start Run</button>
        </form>
      </section>

      <section>
        <h2>Recent Runs</h2>
        <table class="runs-table" {% if not runs %}hidden{% endif %}>
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Inputs</th>
              <th>Artifacts</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody>
            {% for run in runs %}
            <tr data-run-id="{{ run.id }}" data-status="{{ run.status.value }}">
              <td>
                <strong>{{ run.id }}</strong>
                <div class="timestamp">{{ run.created_at.strftime("%Y-%m-%d %H:%M:%S") }} UTC</div>
              </td>
              <td>
                <span class="status-pill status-{{ run.status.value }}{% if run.status.value == 'running' %} status-pulse{% endif %}">{{ run.status.value }}</span>
                {% if run.error %}
                <details>
                  <summary>Error</summary>
                  <pre>{{ run.error }}</pre>
                </details>
                {% endif %}
              </td>
              <td>
                <div>{{ run.input_filename }}</div>
                <div class="log-link">
                  <a href="/runs/{{ run.id }}" data-action="refresh">Refresh</a>
                </div>
              </td>
              <td>
                <div class="download-links">
                  {% if run.archive_path and run.status == run.status.SUCCEEDED %}
                  <a href="/runs/{{ run.id }}/download" role="button">Download Zip</a>
                  {% endif %}
                  {% if run.log_path %}
                  <a href="/runs/{{ run.id }}/log" class="log-link">Log</a>
                  {% endif %}
                </div>
                {% if run.status == run.status.SUCCEEDED %}
                <div class="preview" data-preview="{{ run.id }}">
                  <button type="button" data-action="preview" data-run-id="{{ run.id }}">View Preview</button>
                  <div class="preview-content" hidden></div>
                </div>
                {% endif %}
              </td>
              <td>
                <div class="timestamp">{{ run.updated_at.strftime("%Y-%m-%d %H:%M:%S") }} UTC</div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p data-empty-state {% if runs %}hidden{% endif %}>No runs yet. Kick off the first scrape above.</p>
      </section>
    </main>

    <script>
      const RUNNING_POLL_MS = 2000;
      const IDLE_POLL_MS = 8000;
      const runStatusCache = new Map();
      let pollTimeoutId = null;

      async function pollRuns() {
        try {
          const response = await fetch('/runs', {
            headers: {
              'Accept': 'application/json'
            },
            cache: 'no-store'
          });
          if (!response.ok) {
            throw new Error('Failed to fetch runs');
          }
          const runs = await response.json();
          const { hasRunning, completed } = updateRunTable(runs);
          completed.forEach(highlightCompletion);
          scheduleNextPoll(hasRunning);
        } catch (error) {
          console.error('Run polling failed', error);
          scheduleNextPoll(true);
        }
      }

      function scheduleNextPoll(hasRunning) {
        if (pollTimeoutId) {
          clearTimeout(pollTimeoutId);
        }
        pollTimeoutId = setTimeout(pollRuns, hasRunning ? RUNNING_POLL_MS : IDLE_POLL_MS);
      }

      function updateRunTable(runs) {
        const table = document.querySelector('.runs-table');
        const tbody = table?.querySelector('tbody');
        const emptyState = document.querySelector('[data-empty-state]');

        if (!table || !tbody) {
          return { hasRunning: false, completed: [] };
        }

        const seenIds = new Set();
        let hasRunning = false;
        const completed = [];

        runs.forEach((run) => {
          seenIds.add(run.id);
          const previousStatus = runStatusCache.get(run.id);
          if (previousStatus && previousStatus !== run.status && (run.status === 'succeeded' || run.status === 'failed')) {
            completed.push(run.id);
          }
          runStatusCache.set(run.id, run.status);

          const statusClass = `status-${run.status}`;
          const statusExtra = run.status === 'running' ? ' status-pulse' : '';
          const row = tbody.querySelector(`tr[data-run-id="${run.id}"]`) || document.createElement('tr');
          row.dataset.runId = run.id;
          row.dataset.status = run.status;

          row.innerHTML = `
            <td>
              <strong>${run.id}</strong>
              <div class="timestamp">${formatTimestamp(run.created_at)}</div>
            </td>
            <td>
              <span class="status-pill ${statusClass}${statusExtra}">${run.status}</span>
              ${run.error ? `<details><summary>Error</summary><pre>${run.error}</pre></details>` : ''}
            </td>
            <td>
              <div>${run.input_filename}</div>
            </td>
            <td>
              <div class="download-links">
                ${(run.status === 'succeeded' && run.archive_path)
                  ? `<a href="/runs/${run.id}/download" role="button">Download Zip</a>`
                  : ''}
                ${run.log_path ? `<a href="/runs/${run.id}/log" class="log-link">Log</a>` : ''}
              </div>
              ${run.status === 'succeeded'
                ? `<div class="preview" data-preview="${run.id}">
                     <button type="button" data-action="preview" data-run-id="${run.id}">View Preview</button>
                     <div class="preview-content" hidden></div>
                   </div>`
                : ''}
            </td>
            <td>
              <div class="timestamp">${formatTimestamp(run.updated_at)}</div>
            </td>
          `;

          if (!row.parentElement) {
            tbody.appendChild(row);
          }

          if (run.status === 'running' || run.status === 'queued') {
            hasRunning = true;
          }
        });

        tbody.querySelectorAll('tr').forEach((row) => {
          if (!seenIds.has(row.dataset.runId)) {
            row.remove();
          }
        });

        [...runStatusCache.keys()].forEach((runId) => {
          if (!seenIds.has(runId)) {
            runStatusCache.delete(runId);
          }
        });

        if (emptyState) {
          if (runs.length === 0) {
            emptyState.hidden = false;
            table.hidden = true;
          } else {
            emptyState.hidden = true;
            table.hidden = false;
          }
        }

        return { hasRunning, completed };
      }

      function highlightCompletion(runId) {
        const row = document.querySelector(`tr[data-run-id="${runId}"]`);
        if (!row) return;
        row.classList.add('flash');
        setTimeout(() => row.classList.remove('flash'), 2000);

        const previewContainer = row.querySelector('.preview');
        if (previewContainer && !previewContainer.dataset.autoloaded) {
          const button = previewContainer.querySelector('button[data-action="preview"]');
          if (button) {
            button.click();
            previewContainer.dataset.autoloaded = 'true';
          }
        }
      }

      function formatTimestamp(isoString) {
        const date = new Date(isoString);
        return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')} ${String(date.getUTCHours()).padStart(2, '0')}:${String(date.getUTCMinutes()).padStart(2, '0')}:${String(date.getUTCSeconds()).padStart(2, '0')} UTC`;
      }

      async function handlePreview(event) {
        const button = event.target.closest('button[data-action="preview"]');
        if (!button) return;
        const runId = button.dataset.runId;
        const container = button.closest('.preview');
        const content = container.querySelector('.preview-content');

        if (!content.hasAttribute('hidden')) {
          content.setAttribute('hidden', '');
          button.textContent = 'View Preview';
          content.innerHTML = '';
          return;
        }

        button.disabled = true;
        button.textContent = 'Loading...';

        try {
          const response = await fetch(`/runs/${runId}/preview`);
          if (!response.ok) {
            throw new Error('Preview unavailable');
          }
          const data = await response.json();
          renderPreview(content, data.records);
          content.removeAttribute('hidden');
          button.textContent = 'Hide Preview';
        } catch (error) {
          content.innerHTML = `<p class="timestamp">${error.message}</p>`;
          content.removeAttribute('hidden');
          button.textContent = 'Hide Preview';
        } finally {
          button.disabled = false;
        }
      }

      function renderPreview(container, records) {
        if (!records.length) {
          container.innerHTML = '<p class="timestamp">No preview rows available.</p>';
          return;
        }

        container.innerHTML = records
          .map(
            (record) => `
              <div class="preview-card">
                <h4>${record.title || '(Untitled product)'}</h4>
                <p class="timestamp">Handle: ${record.handle || 'n/a'}</p>
                <details>
                  <summary>View HTML</summary>
                  <div>${record.body_html || '<em>No HTML content</em>'}</div>
                </details>
              </div>
            `
          )
          .join('');
      }

      document.addEventListener('click', handlePreview);
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          pollRuns();
        }
      });
      pollRuns();
    </script>
  </body>
</html>
